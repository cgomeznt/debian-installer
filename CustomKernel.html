<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>


<link rel="shortcut icon" href="http://wiki.debian.org/htdocs/favicon.ico">
<script type="text/javascript" src="CustomKernel_files/bugstatus.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="robots" content="index,nofollow">

<title>DebianInstaller/Modify/CustomKernel - Debian Wiki</title>
<script type="text/javascript" src="CustomKernel_files/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="CustomKernel_files/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="CustomKernel_files/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="CustomKernel_files/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="CustomKernel_files/projection.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="CustomKernel_files/debian-wiki-1.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/msie.css">
<![endif]-->





<link rel="Start" href="http://wiki.debian.org/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel?action=raw">
<link rel="Alternate" media="print" title="Print View" href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel?action=print">
<link rel="Up" href="http://wiki.debian.org/DebianInstaller/Modify">
<link rel="Search" href="http://wiki.debian.org/FindPage">
<link rel="Index" href="http://wiki.debian.org/TitleIndex">
<link rel="Glossary" href="http://wiki.debian.org/WordIndex">
<link rel="Help" href="http://wiki.debian.org/HelpOnFormatting">
</head><body dir="ltr" lang="en">
<div id="logo"><a href="http://www.debian.org/" title="Debian Homepage"><img src="CustomKernel_files/openlogo-50.png" alt="Debian" height="61" width="50"></a></div>
<div id="header">
<div id="wikisection">
<p class="section"><a href="http://wiki.debian.org/" title="Debian Wiki Homepage">Wiki</a></p>
<div id="username"><a href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel?action=login" id="login" rel="nofollow">Login</a></div>
</div>
<div id="navbar">

<ul id="navibar">
<li class="wikilink"><a href="http://wiki.debian.org/FrontPage">FrontPage</a></li><li class="wikilink"><a href="http://wiki.debian.org/RecentChanges">RecentChanges</a></li><li class="wikilink"><a href="http://wiki.debian.org/FindPage">FindPage</a></li><li class="wikilink"><a href="http://wiki.debian.org/HelpContents">HelpContents</a></li><li class="current"><a href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel">CustomKernel</a></li>
</ul>

</div>

<form id="searchform" method="get" action="/DebianInstaller/Modify/CustomKernel">
<div>
<input name="action" value="fullsearch" type="hidden">
<input name="context" value="180" type="hidden">
<label style="display: none;" for="searchinput">Search:</label>
<input class="disabled" id="searchinput" name="value" value="Search" size="20" onfocus="searchFocus(this)" onblur="searchBlur(this)" onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search" type="text">
<input disabled="disabled" id="titlesearch" name="titlesearch" value="Titles" alt="Search Titles" type="submit">
<input disabled="disabled" id="fullsearch" name="fullsearch" value="Text" alt="Search Full Text" type="submit">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="http://www.debian.org/" title="Debian Homepage"><img src="CustomKernel_files/openlogo-50.png" alt="Debian" height="61" width="50"></a></div>

<div id="breadcrumbs"><a href="http://wiki.debian.org/" title="Debian Wiki Homepage">Wiki</a><span class="sep">/</span>

</div>

<ul class="editbar"><li><span class="disabled">Immutable Page</span></li><li class="toggleCommentsButton" style="display: none;"><a href="#" class="nbcomment" onclick="toggleComments();return false;">Comments</a></li><li><a class="nbinfo" href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel?action=info" rel="nofollow">Info</a></li><li><a class="nbattachments" href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="/DebianInstaller/Modify/CustomKernel">
<div>
    
    <select name="action" onchange="if ((this.selectedIndex != 0) &amp;&amp;
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option selected="selected" value="show">More Actions:</option><option value="raw">Raw Text</option>
<option value="print">Print View</option>
<option value="RenderAsDocbook">Render as Docbook</option>
<option value="refresh">Delete Cache</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="SpellCheck">Check Spelling</option>
<option value="LikePages">Like Pages</option>
<option value="LocalSiteMap">Local Site Map</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="RenamePage" disabled="disabled" class="disabled">Rename Page</option>
<option value="DeletePage" disabled="disabled" class="disabled">Delete Page</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Subscribe User</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Remove Spam</option>
<option value="show" disabled="disabled" class="disabled">Revert to this revision</option>
<option value="PackagePages">Package Pages</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="Load">Load</option>
<option value="Save">Save</option>
<option value="SlideShow">SlideShow</option>
    </select>
    
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

<h1 id="locationline">


<ul id="pagelocation">
<li><a href="http://wiki.debian.org/DebianInstaller">DebianInstaller</a></li><li><a href="http://wiki.debian.org/DebianInstaller/Modify">Modify</a></li><li><a class="backlink" href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel?action=fullsearch&amp;context=180&amp;value=linkto%3A%22DebianInstaller%2FModify%2FCustomKernel%22" rel="nofollow" title="Click to do a full-text search for this title">CustomKernel</a></li>
</ul>

</h1>
</div>

<div id="page" dir="ltr" lang="en">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867">
</p><h1 id="Debian-Installer:_Building_images_with_a_custom_kernel">Debian-Installer: Building images with a custom kernel</h1>
<span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line862">So you want to build a custom version of <a href="http://wiki.debian.org/DebianInstaller">DebianInstaller</a>? This <span class="anchor" id="line-4"></span>page assumes basic familiarity with building Debian packages and the <span class="anchor" id="line-5"></span>linux kernel from source. The techniques described here are aimed mostly at <span class="anchor" id="line-6"></span>replacing the kernel, which is the most common piece to need to replace, <span class="anchor" id="line-7"></span>but similar techniques can be used to replace any other udeb used by this <span class="anchor" id="line-8"></span>modular installer with a custom version. <span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span></p><p class="line862">If you have questions about this document, mail the Debian Installer team at: <a class="mailto" href="mailto:debian-boot@lists.debian.org">debian-boot@lists.debian.org</a>. <span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span></p><p class="line867">
</p><h2 id="Step_1._Kernel_deb">Step 1. Kernel deb</h2>
<span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span><p class="line862">You
need to find or produce a kernel deb for the kernel you want to use
with d-i. This can be built in the standard Debian way with make-kpkg.
The kernel should be built with the following things built in:<span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span></p><pre><span class="anchor" id="line-1"></span>!!! Note: this is outdated !!!
<span class="anchor" id="line-2"></span>devfs (only for 2.4; does not need to automount on boot)
<span class="anchor" id="line-3"></span>initrd support
<span class="anchor" id="line-4"></span>tmpfs
<span class="anchor" id="line-5"></span>ext2</pre><span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line874">Most
everything else can be modular, and it's a good idea to enable pretty
much everything. A good starting place is the kernel config from an
existing official Debian kernel. <span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span></p><p class="line862">Make sure that your kernel deb is built with -486 or similar in its version (generally done with <tt>--append-to-version</tt> in make-kpkg). The exact string should match the <tt>flavour</tt> field in the <tt>kernel-versions</tt> file on the linux-kernel-di-*-2.6 package you will use it with (see below). <span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span></p><p class="line874">Once you have the kernel-image.deb, install it for the next step. You do not need to boot into the new kernel. <span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span></p><p class="line867">
</p><h2 id="Step_2._Kernel_udebs">Step 2. Kernel udebs</h2>
<span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line862">Unpack the source package linux-kernel-di-i386 (other arches, replace i386 with your arch). You can find it on <a class="http" href="http://packages.debian.org/unstable/source/linux-kernel-di-i386-2.6">http://packages.debian.org/unstable/source/linux-kernel-di-i386-2.6</a>
download section. In its source tree, edit the kernel-versions file.
Each line in this file is a kernel version, you can comment out all but
one, and modify that one to match the version of your custom kernel. <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span></p><p class="line862">If your custom kernel includes new kernel modules that are not in the standard kernel, you'll need to add them to a list in <tt>modules/i386/</tt>. See the kernel-wedge documentation for details. <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span></p><p class="line874">Make
sure the build dependencies of linux-kernel-di-i386-2.6 are satisfied
(you will need to install the kernel-wedge package), and build the
package. This will produce several udebs. <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span></p><p class="line867">
</p><h2 id="Step_3._Initrds_and_images">Step 3. Initrds and images</h2>
<span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><p class="line862">Unpack the <tt>debian-installer</tt> source package. Make sure the many build dependencies are satisfied. Check that <tt>build/config/i386.cfg</tt>
has a KERNELVERSION field that matches the version of your custom
kernel (other arches, replace i386 with your arch). Note that this
version includes the kernel flavour. For example, if your
kernel-image*.udeb produced in the previous step is named <tt>kernel-image-2.6.18-1-486-di_0.57_i386.udeb</tt>, then set KERNELVERSION to <tt>2.6.18-1-486</tt>. <span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span></p><p class="line862">Copy the udebs that were produced in step 2 into the <tt>build/localudebs</tt> directory. Go to the build directory and type <tt>make&nbsp;list</tt> to see a list of possible targets. For example, if you want to build floppy images, use this command:<span class="anchor" id="line-40"></span></p><pre><span class="anchor" id="line-1-1"></span>fakeroot make build_floppy_boot build_floppy_root</pre><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line862">If you're looking to build a complete Debian CD, the target to use is <tt>build_cdrom_isolinux</tt> (and see step 4). <span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span></p><p class="line862">It turns out to be much easier to build a mini CD containing just d-i, which you can do with the <tt>build_monolithic</tt> target (after editing <tt>config/i386.cfg</tt> and uncommenting the monolithic image type from the first line). <span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span></p><p class="line874">You will need a network connection to install using this image. <span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span></p><p class="line862">Look in the <tt>build/dest</tt> directory for the images. The MANIFEST file will list every file you built and its purpose. Note that the <tt>build_cdrom_isolinux</tt> target does not produce an entire ISO image, but just the initrd to go on one. However, the <tt>build_monolithic</tt> target does produce a bootable ISO image, and the floppy targets do produce floppy images. <span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span></p><p class="line867">
</p><h2 id="Step_3.5._Installing_Your_Custom_Kernel_on_the_Installation_Machine">Step 3.5. Installing Your Custom Kernel on the Installation Machine</h2>
<span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line874">If
you would like to install your custom kernel on the machine you've
built your modified Debian Installer for, you can do the following.
First, you'll need access to your kernel deb from Step 1. Options
include thumb drives that you mount or on web servers that you access
with wget. At the end of the installation process, after the GRUB
install but before reboot, open a virtual terminal, get the kernel deb,
chroot into /target, and install the kernel deb manually with dpkg -i.
Finally, reboot. <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span></p><p class="line867">
</p><h2 id="Step_4._Building_a_full_Debian_CD_image">Step 4. Building a full Debian CD image</h2>
<span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line862">If
you have an initrd for a CD, and some kernel udebs, and a kernel deb,
you probably want to stick them all on a Debian CD. There are two ways
to do this. You can install the <tt>debian-cd</tt> package and read its documentation. Be warned that using <tt>debian-cd</tt>
is difficult, and requires a local Debian mirror. Or you could try to
remaster an existing Debian ISO using the technique described on <a href="http://wiki.debian.org/DebianInstaller/Modify/CD">DebianInstaller/Modify/CD</a>. <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span></p><p class="line862">Neither
of these routes will be as relatively polished or easy as steps 1-3. We
recommend that you don't try to build a full Debian CD unless you
really absolutely need one, and have plenty of time to set up <tt>debian-cd</tt>. An alternative is to build a monolithic mini iso (as described in step 3). <span class="anchor" id="line-60"></span><span class="anchor" id="bottom"></span></p></div><div id="pagebottom"></div>
</div>


<div id="footer">
<p id="pageinfo" class="info" dir="ltr" lang="en">DebianInstaller/Modify/CustomKernel  (last edited 2009-03-16 03:33:45 by <span title="??? @ localhost[127.0.0.1]">localhost</span>)</p>

<ul id="credits">
<li><a href="http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li><li>Debian Wiki <a href="http://wiki.debian.org/Teams/DebianWiki">team</a>, <a href="http://bugs.debian.org/wiki.debian.org">bugs</a> and <a href="http://git.debian.org/?p=collab-maint/wiki.debian.org.git;a=summary">config</a> available.</li><li>Hosting provided by <a href="http://www.dg-i.net/">Dembach Goo Informatik GmbH &amp; Co KG</a></li>
</ul>


</div>
</body></html>