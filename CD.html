<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
<link rel="shortcut icon" href="http://wiki.debian.org/htdocs/favicon.ico">
<script type="text/javascript" src="CD_files/bugstatus.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="robots" content="index,nofollow">

<title>DebianInstaller/Modify/CD - Debian Wiki</title>
<script type="text/javascript" src="CD_files/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="CD_files/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="CD_files/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="CD_files/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="CD_files/projection.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="CD_files/debian-wiki-1.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/msie.css">
<![endif]-->





<link rel="Start" href="http://wiki.debian.org/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="http://wiki.debian.org/DebianInstaller/Modify/CD?action=raw">
<link rel="Alternate" media="print" title="Print View" href="http://wiki.debian.org/DebianInstaller/Modify/CD?action=print">
<link rel="Up" href="http://wiki.debian.org/DebianInstaller/Modify">
<link rel="Search" href="http://wiki.debian.org/FindPage">
<link rel="Index" href="http://wiki.debian.org/TitleIndex">
<link rel="Glossary" href="http://wiki.debian.org/WordIndex">
<link rel="Help" href="http://wiki.debian.org/HelpOnFormatting">
</head>

<body dir="ltr" lang="en">
<div id="logo"><a href="http://www.debian.org/" title="Debian Homepage"><img src="CD_files/openlogo-50.png" alt="Debian" width="50" height="61"></a></div>
<div id="header">
<div id="wikisection">
<p class="section"><a href="http://wiki.debian.org/" title="Debian Wiki Homepage">Wiki</a></p>
<div id="username"><a href="http://wiki.debian.org/DebianInstaller/Modify/CD?action=login" id="login" rel="nofollow">Login</a></div>
</div>
<div id="navbar">

<ul id="navibar">
<li class="wikilink"><a href="http://wiki.debian.org/FrontPage">FrontPage</a></li><li class="wikilink"><a href="http://wiki.debian.org/RecentChanges">RecentChanges</a></li><li class="wikilink"><a href="http://wiki.debian.org/FindPage">FindPage</a></li><li class="wikilink"><a href="http://wiki.debian.org/HelpContents">HelpContents</a></li><li class="current"><a href="http://wiki.debian.org/DebianInstaller/Modify/CD">DebianInstaller/Modify/CD</a></li>
</ul>

</div>

<form id="searchform" method="get" action="/DebianInstaller/Modify/CD">
<div>
<input name="action" value="fullsearch" type="hidden">
<input name="context" value="180" type="hidden">
<label style="display: none;" for="searchinput">Search:</label>
<input class="disabled" id="searchinput" name="value" value="Search" size="20" onfocus="searchFocus(this)" onblur="searchBlur(this)" onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search" type="text">
<input disabled="disabled" id="titlesearch" name="titlesearch" value="Titles" alt="Search Titles" type="submit">
<input disabled="disabled" id="fullsearch" name="fullsearch" value="Text" alt="Search Full Text" type="submit">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="http://www.debian.org/" title="Debian Homepage"><img src="CD_files/openlogo-50.png" alt="Debian" width="50" height="61"></a></div>

<div id="breadcrumbs"><a href="http://wiki.debian.org/" title="Debian Wiki Homepage">Wiki</a><span class="sep">/</span>

</div>

<ul class="editbar"><li><span class="disabled">Immutable Page</span></li><li class="toggleCommentsButton" style="display:none;"><a href="#" class="nbcomment" onclick="toggleComments();return false;">Comments</a></li><li><a class="nbinfo" href="http://wiki.debian.org/DebianInstaller/Modify/CD?action=info" rel="nofollow">Info</a></li><li><a class="nbattachments" href="http://wiki.debian.org/DebianInstaller/Modify/CD?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="/DebianInstaller/Modify/CD">
<div>
    
    <select name="action" onchange="if ((this.selectedIndex != 0) &amp;&amp;
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option selected="selected" value="show">More Actions:</option><option value="raw">Raw Text</option>
<option value="print">Print View</option>
<option value="RenderAsDocbook">Render as Docbook</option>
<option value="refresh">Delete Cache</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="SpellCheck">Check Spelling</option>
<option value="LikePages">Like Pages</option>
<option value="LocalSiteMap">Local Site Map</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="RenamePage" disabled="disabled" class="disabled">Rename Page</option>
<option value="DeletePage" disabled="disabled" class="disabled">Delete Page</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Subscribe User</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Remove Spam</option>
<option value="show" disabled="disabled" class="disabled">Revert to this revision</option>
<option value="PackagePages">Package Pages</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="Load">Load</option>
<option value="Save">Save</option>
<option value="SlideShow">SlideShow</option>
    </select>
    
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

<h1 id="locationline">


<ul id="pagelocation">
<li><a href="http://wiki.debian.org/DebianInstaller">DebianInstaller</a></li><li><a href="http://wiki.debian.org/DebianInstaller/Modify">Modify</a></li><li><a class="backlink" href="http://wiki.debian.org/DebianInstaller/Modify/CD?action=fullsearch&amp;context=180&amp;value=linkto%3A%22DebianInstaller%2FModify%2FCD%22" rel="nofollow" title="Click to do a full-text search for this title">CD</a></li>
</ul>

</h1>
</div>

<div id="page" dir="ltr" lang="en">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867">
</p><h1 id="Debian-Installer:_How_to_modify_an_existing_CD_image">Debian-Installer: How to modify an existing CD image</h1>
<span class="anchor" id="line-4"></span><p class="line867"><a href="http://wiki.debian.org/DebianInstaller">DebianInstaller</a>
 itself is based on udebs. Many of those udebs are on the CD, but some 
of them are in an initrd. If you want to modify the udeb's in the 
initrd, then you should follow the instructions on <a href="http://wiki.debian.org/DebianInstaller/Modify/CustomKernel">DebianInstaller/Modify/CustomKernel</a>. <span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span></p><p class="line874">But
 when you want to modify non-initrd udeb's or you want to substitute or 
amend the *.debs, you can do this without the source code. <span class="anchor" id="line-7"></span><span class="anchor" id="line-8"></span></p><p class="line867"></p><div class="table-of-contents"><p class="table-of-contents-heading">Contents</p><ol><li>
<a href="#Debian-Installer:_How_to_modify_an_existing_CD_image">Debian-Installer: How to modify an existing CD image</a><ol><li>
<a href="#Create_copy_of_the_image">Create copy of the image</a></li><li>
<a href="#Files_and_hooks">Files and hooks</a></li><li>
<a href="#Modify_Image">Modify Image</a><ol><li>
<a href="#Workaround_bug_in_deboostrap">Workaround bug in deboostrap</a></li><li>
<a href="#Create_new__Release_and_Packages_files">Create new  Release and Packages files</a></li><li>
<a href="#Alternate_Method">Alternate Method</a></li></ol></li><li>
<a href="#Fix_md5sum.27s">Fix md5sum's</a></li><li>
<a href="#Create_new_image">Create new image</a></li><li>
<a href="#Helper_scripts:_diunpk.2C_dipk">Helper scripts: diunpk, dipk</a></li></ol></li></ol></div> <span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span><p class="line867">
</p><h2 id="Create_copy_of_the_image">Create copy of the image</h2>
<span class="anchor" id="line-11"></span><p class="line874">You need an already built ISO image from <span class="anchor" id="line-12"></span><a class="http" href="http://cdimage.debian.org/cdimage/daily-builds/sid_d-i/">http://cdimage.debian.org/cdimage/daily-builds/sid_d-i/</a>. <span class="anchor" id="line-13"></span>That is the basis of the image that gets modified. Because you can't modify an <a class="nonexistent" href="http://wiki.debian.org/ISO9660">ISO9660</a> image you must extract it first:<span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span></p><pre><span class="anchor" id="line-1"></span> $ rm -rf cd
<span class="anchor" id="line-2"></span> $ mkdir cd
<span class="anchor" id="line-3"></span> $ bsdtar -C cd -xf your-image.iso</pre><span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><p class="line867">
</p><h2 id="Files_and_hooks">Files and hooks</h2>
<span class="anchor" id="line-20"></span><p class="line862">A list of hooks available for debian-installer: <a class="http" href="http://git.debian.org/?p=d-i/debian-installer.git;a=blob;f=doc/devel/internals/available-hooks.xml">http://git.debian.org/?p=d-i/debian-installer.git;a=blob;f=doc/devel/internals/available-hooks.xml</a> (XML source for the D-I Internals manual - does anyone know of this manual being available as compiled HTML anywhere?) <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span></p><pre><span class="anchor" id="line-1-1"></span> (filepaths as seen from the installer)</pre><span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><p class="line862">List of packages (udebs) to install or not install in into the d-i ramdisk.<span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span></p><pre><span class="anchor" id="line-1-2"></span>  ''cdrom''.disk/udeb_include ["anna"]
<span class="anchor" id="line-2-1"></span>  ''cdrom''.disk/udeb_exclude</pre><span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line862">The content of these files are taken as lists of packages to install or not into the target area.<span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span></p><pre><span class="anchor" id="line-1-3"></span>  ''cdrom''.disk/base_include [base-installer]
<span class="anchor" id="line-2-2"></span>  ''cdrom''.disk/base_exclude</pre><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><p class="line862">If the file <tt>''cdrom''.disk/base_installable</tt> exists,  <span class="anchor" id="line-36"></span>the base-installer udeb selects the cdrom as <span class="anchor" id="line-37"></span>source for the installation. <span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span></p><p class="line867">
</p><h2 id="Modify_Image">Modify Image</h2>
<span class="anchor" id="line-41"></span><p class="line862">Now put all the packages that you want on your image into <tt>pool/main</tt> (or below) in this copy. You also have to change/add md5 checksum in md5sum.txt in <tt>cd</tt> <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span></p><p class="line867">
</p><h3 id="Workaround_bug_in_deboostrap">Workaround bug in deboostrap</h3>
<span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><p class="line862">There is this bug in debootstrap: <a title="Open in debootstrap/1.0.10lenny1: #601670: debootstrap script install base-files and base-passwd depends on them in Packages file's sequence" class="interwiki open-bug" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=601670">debootstrap script install base-files and base-passwd depends on them in Packages file's sequence</a>. Basically, <tt>debootstrap</tt> is sensitive to whether the <tt>base-files</tt> or <tt>base-passwd</tt> is listed first in the <tt>Packages</tt> file. It shouldn't care. <span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span></p><p class="line874">Because of it, we have two options if we want our modified CD to actually work: <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span></p><ol type="1"><li><p class="line862">Patch the <tt>debootstrap</tt> <tt>functions</tt> file on the CD. <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span></p></li><li class="gap"><p class="line862">Modify the sequence of packages in <tt>Packages</tt> generated by <tt>apt-ftparchive</tt> <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span></p></li></ol><p class="line862">Here, we do the first alternative above and patch <tt>debootstrap</tt>. Save this as a script and run it: <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span></p><pre><span class="anchor" id="line-1-4"></span># For some reason, the wiki software eats my first script line which is
<span class="anchor" id="line-2-3"></span>#!/bin/bash
<span class="anchor" id="line-3-1"></span>
<span class="anchor" id="line-4"></span># -e  Exit immediately if a command exits with a non-zero status
<span class="anchor" id="line-5"></span>set -e
<span class="anchor" id="line-6"></span># -x  Print commands and their arguments as they are executed
<span class="anchor" id="line-7"></span>set -x
<span class="anchor" id="line-8"></span>
<span class="anchor" id="line-9"></span># I tried to put the patch inline as a here-doc, but the wiki software messed
<span class="anchor" id="line-10"></span># up the whitespace and so the patch was corrupt. The patch here is from 
<span class="anchor" id="line-11"></span># #601670 - debootstrap script install base-files and base-passwd depends on them in Packages file's sequence - Debian Bug report logs
<span class="anchor" id="line-12"></span># http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=601670
<span class="anchor" id="line-13"></span>wget -O debootstrapFunctions.patch http://pastebin.com/download.php?i=JudHSnWE
<span class="anchor" id="line-14"></span>
<span class="anchor" id="line-15"></span>mkdir -p debootstrapPatch/DEBIAN
<span class="anchor" id="line-16"></span>dpkg-deb --fsys-tarfile cd/pool/main/d/debootstrap/debootstrap*.udeb | tar -C debootstrapPatch -x
<span class="anchor" id="line-17"></span>dpkg-deb -e cd/pool/main/d/debootstrap/debootstrap*.udeb debootstrapPatch/DEBIAN/
<span class="anchor" id="line-18"></span>patch debootstrapPatch/usr/share/debootstrap/functions &lt; debootstrapFunctions.patch 
<span class="anchor" id="line-19"></span># Prints:
<span class="anchor" id="line-20"></span># patching file debootstrapPatch/usr/share/debootstrap/functions
<span class="anchor" id="line-21"></span>dpkg-deb --build debootstrapPatch
<span class="anchor" id="line-22"></span># Prints:
<span class="anchor" id="line-23"></span># dpkg-deb: building package `debootstrap-udeb' in `debootstrapPatch.deb'.
<span class="anchor" id="line-24"></span>mv debootstrapPatch.deb cd/pool/main/d/debootstrap/debootstrap*.udeb
<span class="anchor" id="line-25"></span>
<span class="anchor" id="line-26"></span># Clean up
<span class="anchor" id="line-27"></span>rm -r debootstrapPatch debootstrapFunctions.patch</pre><span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><p class="line867">
</p><h3 id="Create_new__Release_and_Packages_files">Create new  Release and Packages files</h3>
<span class="anchor" id="line-85"></span><p class="line874">This step is required only if you have added or changed packages. <span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span></p><p class="line862">Create a <tt>config-udeb</tt> file with something like this :<span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span></p><pre><span class="anchor" id="line-1-5"></span> Dir {
<span class="anchor" id="line-2-4"></span>    ArchiveDir "cd";
<span class="anchor" id="line-3-2"></span>    OverrideDir "indices";
<span class="anchor" id="line-4-1"></span>    CacheDir "indices";
<span class="anchor" id="line-5-1"></span> };
<span class="anchor" id="line-6-1"></span>            
<span class="anchor" id="line-7-1"></span> TreeDefault {
<span class="anchor" id="line-8-1"></span>    Directory "pool/";
<span class="anchor" id="line-9-1"></span> };
<span class="anchor" id="line-10-1"></span>                    
<span class="anchor" id="line-11-1"></span> BinDirectory "pool/main" {
<span class="anchor" id="line-12-1"></span>    Packages "dists/squeeze/main/debian-installer/binary-i386/Packages";
<span class="anchor" id="line-13-1"></span>    BinOverride "override";
<span class="anchor" id="line-14-1"></span>    ExtraOverride "override.extra";
<span class="anchor" id="line-15-1"></span> };
<span class="anchor" id="line-16-1"></span>                                   
<span class="anchor" id="line-17-1"></span> Default {
<span class="anchor" id="line-18-1"></span>    Packages {
<span class="anchor" id="line-19-1"></span>        Extensions ".udeb";
<span class="anchor" id="line-20-1"></span>    };
<span class="anchor" id="line-21-1"></span> };</pre><span class="anchor" id="line-110"></span><p class="line862">and a <tt>config-deb</tt> file with something like this :<span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span></p><pre><span class="anchor" id="line-1-6"></span> Dir {
<span class="anchor" id="line-2-5"></span>    ArchiveDir "cd";
<span class="anchor" id="line-3-3"></span>    OverrideDir "indices";
<span class="anchor" id="line-4-2"></span>    CacheDir "indices";
<span class="anchor" id="line-5-2"></span> };
<span class="anchor" id="line-6-2"></span>            
<span class="anchor" id="line-7-2"></span> TreeDefault {
<span class="anchor" id="line-8-2"></span>    Directory "pool/";
<span class="anchor" id="line-9-2"></span> };
<span class="anchor" id="line-10-2"></span>                    
<span class="anchor" id="line-11-2"></span> BinDirectory "pool/main" {
<span class="anchor" id="line-12-2"></span>    Packages "dists/squeeze/main/binary-i386/Packages";
<span class="anchor" id="line-13-2"></span>    BinOverride "override";
<span class="anchor" id="line-14-2"></span>    ExtraOverride "override.extra";
<span class="anchor" id="line-15-2"></span> };
<span class="anchor" id="line-16-2"></span>                                   
<span class="anchor" id="line-17-2"></span> Default {
<span class="anchor" id="line-18-2"></span>    Packages {
<span class="anchor" id="line-19-2"></span>        Extensions ".deb";
<span class="anchor" id="line-20-2"></span>    };
<span class="anchor" id="line-21-2"></span> };</pre><span class="anchor" id="line-133"></span><p class="line874">The first is for the .udeb packages used by the Debian installer; the second is for Debian .deb packages. <span class="anchor" id="line-134"></span>Because of the <tt>BinOverride</tt> line you also need the override file, you can get it from any debian mirror, e.g. get <a class="http" href="http://ftp.de.debian.org/debian/indices/override.squeeze.main.gz">http://ftp.de.debian.org/debian/indices/override.squeeze.main.gz</a> and extract it to the <tt>indices/override</tt>. <span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span></p><p class="line862">Now go into the directory with your <tt>config</tt> file and run<span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span></p><pre><span class="anchor" id="line-1-7"></span> # apt-ftparchive generate config-udeb
<span class="anchor" id="line-2-6"></span> # apt-ftparchive generate config-deb</pre><span class="anchor" id="line-140"></span><p class="line862">to generate the <tt>Packages</tt> and <tt>Releases</tt> files. <span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span></p><p class="line862">To update the <tt>cd/dists/squeeze/Release</tt> file, make a new text file called <tt>config-rel</tt> with something like this:<span class="anchor" id="line-143"></span><span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span><span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span><span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span></p><pre><span class="anchor" id="line-1-8"></span>APT::FTPArchive::Release::Codename "squeeze";
<span class="anchor" id="line-2-7"></span>APT::FTPArchive::Release::Origin "Debian";
<span class="anchor" id="line-3-4"></span>APT::FTPArchive::Release::Components "main";
<span class="anchor" id="line-4-3"></span>APT::FTPArchive::Release::Label "Debian";
<span class="anchor" id="line-5-3"></span>APT::FTPArchive::Release::Architectures "i386";
<span class="anchor" id="line-6-3"></span>APT::FTPArchive::Release::Suite "testing";</pre><span class="anchor" id="line-150"></span><p class="line862">To generate the <tt>Release</tt> file, run<span class="anchor" id="line-151"></span><span class="anchor" id="line-152"></span></p><pre><span class="anchor" id="line-1-9"></span> # apt-ftparchive -c config-rel release cd/dists/squeeze &gt; cd/dists/squeeze/Release</pre><span class="anchor" id="line-153"></span><span class="anchor" id="line-154"></span><p class="line867">
</p><h3 id="Alternate_Method">Alternate Method</h3>
<span class="anchor" id="line-155"></span><p class="line862">If you use <strong>apt-move</strong>
 to store the packages apt downloads when updating your system, you can 
use the mirror it creates to fill the cdrom with all the packages on 
your current system. Remember to call "apt-move sync" before mastering 
the image, to make sure, all dependencies are met. <span class="anchor" id="line-156"></span><span class="anchor" id="line-157"></span></p><p class="line867">
</p><h2 id="Fix_md5sum.27s">Fix md5sum's</h2>
<span class="anchor" id="line-158"></span><p class="line867"><span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span></p><pre><span class="anchor" id="line-1-10"></span> # cd cd; md5sum `find ! -name "md5sum.txt" ! -path "./isolinux/*" -follow -type f` &gt; md5sum.txt; cd ..</pre><span class="anchor" id="line-161"></span><span class="anchor" id="line-162"></span><p class="line867">
</p><h2 id="Create_new_image">Create new image</h2>
<span class="anchor" id="line-163"></span><p class="line874">To make the
 cdrom bootable, you need to run mkisofs with appropriate parameters. 
Here is how to do it for x86/amd64, using isolinux. <span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span></p><p class="line874">Change to the top of the cd directory then: <span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span></p><p class="line862">To create the cdrom image using the isolinux boot image:<span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span><span class="anchor" id="line-170"></span></p><pre><span class="anchor" id="line-1-11"></span> # mkisofs -o test.iso -r -J -no-emul-boot -boot-load-size 4 \
<span class="anchor" id="line-2-8"></span> -boot-info-table -b isolinux/isolinux.bin -c isolinux/boot.cat ./cd </pre><span class="anchor" id="line-171"></span><span class="anchor" id="line-172"></span><p class="line862">or, if your extra dists and pool (the apt-move mirror) are in a separate place<span class="anchor" id="line-173"></span><span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span><span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span></p><pre><span class="anchor" id="line-1-12"></span> # mkisofs -o test.iso -r -J -no-emul-boot -boot-load-size 4 \
<span class="anchor" id="line-2-9"></span> -boot-info-table -b isolinux/isolinux.bin -c isolinux/boot.cat \
<span class="anchor" id="line-3-5"></span> extra/dists=pathto/mirror/dists extra/pool=pathto/mirror/pool \
<span class="anchor" id="line-4-4"></span> -graft-points ./cd</pre><span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span><p class="line874">if you want you could do a (very) quick test of the iso using qemu (you need to apt-get it): <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span><span class="anchor" id="line-182"></span></p><pre><span class="anchor" id="line-1-13"></span> # qemu -user-net -cdrom test.iso</pre><span class="anchor" id="line-183"></span><span class="anchor" id="line-184"></span><p class="line862">burn the image to cdrom<span class="anchor" id="line-185"></span><span class="anchor" id="line-186"></span></p><pre><span class="anchor" id="line-1-14"></span> # cdrecord -dev /dev/hd? test.iso</pre><span class="anchor" id="line-187"></span><span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span><p class="line874">Finally, from the build directory (please adapt to your local paths): <span class="anchor" id="line-191"></span><span class="anchor" id="line-192"></span><span class="anchor" id="line-193"></span><span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span><span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span><span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span><span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span><span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span><span class="anchor" id="line-204"></span></p><pre><span class="anchor" id="line-1-15"></span> #!/bin/sh
<span class="anchor" id="line-2-10"></span> make clean
<span class="anchor" id="line-3-6"></span> TYPE=cdrom fakeroot make image
<span class="anchor" id="line-4-5"></span> cp myudebs/*udeb \
<span class="anchor" id="line-5-4"></span>       /home/vmware/bubulle/src/debian/d-i/archive/pool/main
<span class="anchor" id="line-6-4"></span> MYPWD=`pwd`
<span class="anchor" id="line-7-3"></span> cd /home/vmware/bubulle/src/debian/d-i/archive
<span class="anchor" id="line-8-3"></span> apt-ftparchive generate config
<span class="anchor" id="line-9-3"></span> cd $MYPWD
<span class="anchor" id="line-10-3"></span> mkisofs -r -J -b cdrom-image.img -o test.iso dest \
<span class="anchor" id="line-11-3"></span>    /home/vmware/bubulle/src/debian/d-i/archive
<span class="anchor" id="line-12-3"></span> mkisofs -r -J -b cdrom-image.img -o test.iso dest /mnt/loop</pre><span class="anchor" id="line-205"></span><span class="anchor" id="line-206"></span><p class="line862">A
 bit clumsy but this works, at least for me. This is how I tested the 
modified partitioner (which does not go to initrd as it requires 
fdisk-udeb which is huge). For smaller package tests, you may modify <tt>pkg-lists/cdrom/&lt;arch&gt;</tt>, add them there and drop the udebs to <tt>localudebs</tt>. <span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span></p><p class="line867">
</p><h2 id="Helper_scripts:_diunpk.2C_dipk">Helper scripts: diunpk, dipk</h2>
<span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span><p class="line874">Here are example scripts for unpacking and packing d-i CD image file.  You need to have aufs modules available. <span class="anchor" id="line-211"></span><span class="anchor" id="line-212"></span></p><p class="line874">* diunpk: execute this with d-i.iso file as its argument.  This generates tree under dated directory and cd into it. <span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span><span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><span class="anchor" id="line-217"></span><span class="anchor" id="line-218"></span><span class="anchor" id="line-219"></span><span class="anchor" id="line-220"></span><span class="anchor" id="line-221"></span><span class="anchor" id="line-222"></span><span class="anchor" id="line-223"></span><span class="anchor" id="line-224"></span><span class="anchor" id="line-225"></span><span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span><span class="anchor" id="line-228"></span><span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span><span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span><span class="anchor" id="line-236"></span><span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span><span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span><span class="anchor" id="line-241"></span><span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span></p><pre><span class="anchor" id="line-1-16"></span>#!/bin/sh -e
<span class="anchor" id="line-2-11"></span>
<span class="anchor" id="line-3-7"></span># Local customization to match your id (check with 'id' command).
<span class="anchor" id="line-4-6"></span>uid=1000
<span class="anchor" id="line-5-5"></span>gid=1000
<span class="anchor" id="line-6-5"></span>
<span class="anchor" id="line-7-4"></span># Default values
<span class="anchor" id="line-8-4"></span># $1 d-i iso image file
<span class="anchor" id="line-9-4"></span># $2 d-i ro mount point
<span class="anchor" id="line-10-4"></span># $3 d-i rw tree
<span class="anchor" id="line-11-4"></span>
<span class="anchor" id="line-12-4"></span>di_iso=${1:-d-i.iso}
<span class="anchor" id="line-13-3"></span>di_ro=${2:-d-i.ro}
<span class="anchor" id="line-14-3"></span>di_rw=${3:-d-i.rw}
<span class="anchor" id="line-15-3"></span>
<span class="anchor" id="line-16-3"></span>pwd=$(pwd)
<span class="anchor" id="line-17-3"></span>timestamp=$(date -u +%Y%m%d%H%M%S)
<span class="anchor" id="line-18-3"></span>mkdir $timestamp
<span class="anchor" id="line-19-3"></span>
<span class="anchor" id="line-20-3"></span>mkdir $timestamp/$di_ro
<span class="anchor" id="line-21-3"></span>mkdir $timestamp/$di_rw
<span class="anchor" id="line-22-1"></span>
<span class="anchor" id="line-23-1"></span>sudo mount ${di_iso} $timestamp/${di_ro} -t iso9660 -o loop,uid=${uid},gid=${gid}
<span class="anchor" id="line-24-1"></span>sudo mount -t aufs -o br:$timestamp/${di_rw}:$timestamp/${di_ro} none $timestamp/${di_rw}
<span class="anchor" id="line-25-1"></span>sudo chmod u+w $timestamp/${di_rw}
<span class="anchor" id="line-26-1"></span>sudo chmod u+w $timestamp/${di_rw}/md5sum.txt
<span class="anchor" id="line-27-1"></span>sudo find $timestamp/${di_rw}/dists -exec chmod u+w {} \;
<span class="anchor" id="line-28"></span>sudo find $timestamp/${di_rw}/pool  -type d -exec chmod u+w {} \;
<span class="anchor" id="line-29"></span>cd $timestamp</pre><span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span><p class="line874">* dipk: execute this in dated directory. <span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span><span class="anchor" id="line-248"></span><span class="anchor" id="line-249"></span><span class="anchor" id="line-250"></span><span class="anchor" id="line-251"></span><span class="anchor" id="line-252"></span><span class="anchor" id="line-253"></span><span class="anchor" id="line-254"></span><span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span><span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span><span class="anchor" id="line-259"></span><span class="anchor" id="line-260"></span><span class="anchor" id="line-261"></span><span class="anchor" id="line-262"></span><span class="anchor" id="line-263"></span><span class="anchor" id="line-264"></span><span class="anchor" id="line-265"></span><span class="anchor" id="line-266"></span><span class="anchor" id="line-267"></span><span class="anchor" id="line-268"></span><span class="anchor" id="line-269"></span><span class="anchor" id="line-270"></span><span class="anchor" id="line-271"></span><span class="anchor" id="line-272"></span><span class="anchor" id="line-273"></span><span class="anchor" id="line-274"></span><span class="anchor" id="line-275"></span><span class="anchor" id="line-276"></span><span class="anchor" id="line-277"></span><span class="anchor" id="line-278"></span><span class="anchor" id="line-279"></span><span class="anchor" id="line-280"></span><span class="anchor" id="line-281"></span><span class="anchor" id="line-282"></span><span class="anchor" id="line-283"></span><span class="anchor" id="line-284"></span><span class="anchor" id="line-285"></span><span class="anchor" id="line-286"></span><span class="anchor" id="line-287"></span><span class="anchor" id="line-288"></span><span class="anchor" id="line-289"></span><span class="anchor" id="line-290"></span><span class="anchor" id="line-291"></span><span class="anchor" id="line-292"></span><span class="anchor" id="line-293"></span><span class="anchor" id="line-294"></span><span class="anchor" id="line-295"></span><span class="anchor" id="line-296"></span><span class="anchor" id="line-297"></span><span class="anchor" id="line-298"></span><span class="anchor" id="line-299"></span><span class="anchor" id="line-300"></span></p><pre><span class="anchor" id="line-1-17"></span>#!/bin/sh -e
<span class="anchor" id="line-2-12"></span>set -x
<span class="anchor" id="line-3-8"></span># Local customization
<span class="anchor" id="line-4-7"></span>uid=1000
<span class="anchor" id="line-5-6"></span>gid=1000
<span class="anchor" id="line-6-6"></span>arch=amd64
<span class="anchor" id="line-7-5"></span>release=squeeze
<span class="anchor" id="line-8-5"></span>
<span class="anchor" id="line-9-5"></span># Default values
<span class="anchor" id="line-10-5"></span># $1 d-i iso image file
<span class="anchor" id="line-11-5"></span># $2 d-i ro mount point
<span class="anchor" id="line-12-5"></span># $3 d-i rw tree
<span class="anchor" id="line-13-4"></span>
<span class="anchor" id="line-14-4"></span>di_iso=${1:-d-i.iso}
<span class="anchor" id="line-15-4"></span>di_ro=${2:-d-i.ro}
<span class="anchor" id="line-16-4"></span>di_rw=${3:-d-i.rw}
<span class="anchor" id="line-17-4"></span>
<span class="anchor" id="line-18-4"></span>cat &gt; config &lt;&lt; EOF
<span class="anchor" id="line-19-4"></span>Dir {
<span class="anchor" id="line-20-4"></span>    ArchiveDir ".";
<span class="anchor" id="line-21-4"></span>    OverrideDir ".";
<span class="anchor" id="line-22-2"></span>    CacheDir ".";
<span class="anchor" id="line-23-2"></span> };
<span class="anchor" id="line-24-2"></span>            
<span class="anchor" id="line-25-2"></span> TreeDefault {
<span class="anchor" id="line-26-2"></span>    Directory "pool/";
<span class="anchor" id="line-27-2"></span> };
<span class="anchor" id="line-28-1"></span>                    
<span class="anchor" id="line-29-1"></span> BinDirectory "pool/main" {
<span class="anchor" id="line-30"></span>    Packages "dists/${release}/main/debian-installer/binary-${arch}/Packages";
<span class="anchor" id="line-31"></span> };
<span class="anchor" id="line-32"></span>                                   
<span class="anchor" id="line-33"></span> Default {
<span class="anchor" id="line-34"></span>    Packages {
<span class="anchor" id="line-35"></span>        Extensions ".udeb";
<span class="anchor" id="line-36"></span>    };
<span class="anchor" id="line-37"></span> };
<span class="anchor" id="line-38"></span>EOF
<span class="anchor" id="line-39"></span>
<span class="anchor" id="line-40"></span>cd $di_rw
<span class="anchor" id="line-41"></span>sudo apt-ftparchive generate ../config
<span class="anchor" id="line-42"></span>sudo md5sum $(find ! -name "md5sum.txt" ! -path "./isolinux/*" -follow -type f) &gt; md5sum.txt
<span class="anchor" id="line-43"></span>cd -
<span class="anchor" id="line-44"></span>
<span class="anchor" id="line-45"></span>#genisoimage ...
<span class="anchor" id="line-46"></span>sudo genisoimage -r -o $di_iso -V di$(date -u +%m%d%H%M%S) \
<span class="anchor" id="line-47"></span>   -b isolinux/isolinux.bin -c isolinux/boot.cat \
<span class="anchor" id="line-48"></span>   -no-emul-boot -boot-load-size 4 -boot-info-table $di_rw
<span class="anchor" id="line-49"></span>
<span class="anchor" id="line-50"></span># check mounted by "mount"
<span class="anchor" id="line-51"></span>#sudo umount ${di_rw}
<span class="anchor" id="line-52"></span>#sudo umount ${di_ro}
<span class="anchor" id="line-53"></span>#rm -rf $di_rw</pre><span class="anchor" id="line-301"></span><span class="anchor" id="bottom"></span></div><div id="pagebottom"></div>
</div>


<div id="footer">
<p id="pageinfo" class="info" dir="ltr" lang="en">DebianInstaller/Modify/CD  (last edited 2011-08-08 07:34:49 by <span title="PeterValdemarMørch @ 188.180.87.161[188.180.87.161]"><a class="nonexistent" href="http://wiki.debian.org/PeterValdemarM%C3%B8rch" title="PeterValdemarMørch @ 188.180.87.161[188.180.87.161]">PeterValdemarMørch</a></span>)</p>

<ul id="credits">
<li><a href="http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li><li>Debian Wiki <a href="http://wiki.debian.org/Teams/DebianWiki">team</a>, <a href="http://bugs.debian.org/wiki.debian.org">bugs</a> and <a href="http://git.debian.org/?p=collab-maint/wiki.debian.org.git;a=summary">config</a> available.</li><li>Hosting provided by <a href="http://www.dg-i.net/">Dembach Goo Informatik GmbH &amp; Co KG</a></li>
</ul>


</div>



</body></html>